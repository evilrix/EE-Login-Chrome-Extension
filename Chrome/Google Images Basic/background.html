<html>
<head>
  <script>
	var reMain = /(?!.+sout=1)^http:\/\/[^.]+\.google\.[^\/]+\/(?:images|.+&tbm=isch)/;
	var rePrev = /http:\/\/[^.]+\.google\.[^\/]+\/.+[&?]imgurl=([^&]+)/;
	
	function handleMain(tab)
	{
		chrome.tabs.update(tab.id, {'url': tab.url + '&sout=1'});
	}
	
	function handlePrev(tab, newurl)
	{
		chrome.tabs.update(tab.id, {'url': newurl});
	}

    chrome.pageAction.onClicked.addListener(function(tab) {
		handle(tab);
    });
	
    chrome.tabs.onUpdated.addListener( function (tabId, changeInfo, tab) {

	if(changeInfo.status == "loading")
		{			
			if(reMain.test(tab.url))
			{
				if(localStorage["automatic"] == "true")
				{
					handleMain(tab);
				}
				else
				{
					chrome.pageAction.show(tab.id);
				}
			}
			else
			{
				var match = rePrev.exec(tab.url);
				
				if(match && localStorage["noprev"] == "true")
				{
					handlePrev(tab, match[1]);
				}
			}
		}
    });
  </script>
  </head>
</html>

