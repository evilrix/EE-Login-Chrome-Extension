<html>
  <script>
	function handler(tab, detach) {
	
		if(!localStorage["username"])
		{
			alert("You need to configure your EE username and password.");
			chrome.tabs.create({'url': "options.html"});
			return;
		}
		
		var url = "https://secure.experts-exchange.com/login.jsp"
		url += "?msuLoginName=" + localStorage["username"];
		url += "&msuPassword=" + localStorage["password"];
		url += "&msuLoginSubmit=1&redirectURL=" + tab.url;

		if(detach)
		{
			chrome.tabs.remove(tab.id);
		}

		chrome.windows.create({
			'url': url,
			'incognito': true
		});			
		
    }

    chrome.pageAction.onClicked.addListener(handler);
	
	var re = {
		'gn': /^http:\/\/www\.experts-exchange\.com\//,
		'md': /^http:\/\/www.experts-exchange.com\/Community_Support\/Hidden\/(?:Admin_Only|Mods_Only)\//,
		'za': /^http:\/\/www.experts-exchange.com\/Community_Support\/Hidden\/Admin_Mod_ZA_Only\//,
		'pe': /^http:\/\/www.experts-exchange.com\/Community_Support\/Hidden\/Admin_Mod_PE_Only\//,
		'pd': /^http:\/\/www.experts-exchange.com\/Community_Support\/Hidden\/Private_Discussions\//,
		'cv': /^http:\/\/www.experts-exchange.com\/Community_Support\/Hidden\/CV_Admin\//,
		'cs': /^http:\/\/www.experts-exchange.com\/Community_Support\/Hidden\/(?!Admin_Only|Mods_Only|Admin_Mod_ZA_Only|Admin_Mod_PE_Only|Private_Discussions|CV_Admin)\//
	};
	
	function zone_handler(name, tab) {
		var ret = false
		
		if(localStorage[name] > 0 && re[name].test(tab.url))
		{
			handler(tab, (localStorage[name] == 2));
			ret = true;
		}
		
		return ret;
	}
	
    chrome.tabs.onUpdated.addListener( function (tabId, changeInfo, tab) {

	if(changeInfo.status == "loading") {
			if(tab.incognito)	{
			
				alert("EE Login doesn't work in incognito mode, please disable it!");
				
			} else {
			
				if(re['gn'].test(tab.url)) {
				
					chrome.pageAction.show(tabId);
					
					zone_handler('md', tab) ||
					zone_handler('za', tab) ||
					zone_handler('pe', tab) ||
					zone_handler('pd', tab) ||
					zone_handler('cv', tab) ||
					zone_handler('cs', tab);
				}
			}
		}
    });	
  </script>
</html>

