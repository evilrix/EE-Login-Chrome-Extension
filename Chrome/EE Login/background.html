<html>
  <script>
	var re = {
		'ee': /^http:\/\/[^.]+\.experts-exchange\.com\//,
		'md': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/(?:Admin_Only|Mods_Only)\//,
		'za': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/Admin_Mod_ZA_Only\//,
		'pe': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/(?:PE_Adm|Admin_Mod_PE_Only)\//,
		'pd': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/Private_Discussions\//,
		'cv': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/CV_Admin\//,
		'cg': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/General\//,
		'cs': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/(?!Admin_Only|Mods_Only|Admin_Mod_ZA_Only|Admin_Mod_PE_Only|Private_Discussions|CV_Admin)\//
	};
		
	function handle_login(tab, detach)
	{
		if(!localStorage["username"])
		{
			alert("You need to configure your EE username and password.");
			chrome.tabs.create({'url': "options.html"});
			return;
		}
		
		var url = "https://secure.experts-exchange.com/login.jsp"
		url += "?msuLoginName=" + localStorage["username"];
		url += "&msuPassword=" + localStorage["password"];
		url += "&msuLoginSubmit=1&redirectURL=" + tab.url;

		if(detach)
		{
			chrome.tabs.remove(tab.id);
		}

		chrome.windows.create({
			'url': url,
			'incognito': true
		});				
	}
	
	function zone_handler(name, tab) {
		var ret = false
		
		if(localStorage[name] > 0 && re[name].test(tab.url))
		{
			handle_login(tab, (localStorage[name] == 2));
			ret = true;
		}
		
		return ret;
	}

	function onUpdate_handler(tabId, changeInfo, tab) {

		if(changeInfo.status == "loading") {
			if(tab.incognito)	{
			
				alert("EE Login doesn't work in incognito mode, please disable it!");
				
			} else {
			
				if(re['ee'].test(tab.url)) {
				
					chrome.pageAction.show(tabId);
					
					zone_handler('md', tab) ||
					zone_handler('za', tab) ||
					zone_handler('pe', tab) ||
					zone_handler('pd', tab) ||
					zone_handler('cv', tab) ||
					zone_handler('cg', tab) ||
					zone_handler('cs', tab);
				}
			}
		}
	}
	
	function onClick_handler(tab) {
	
		handle_login(tab, localStorage["detonman"] == "true");
    }
		
    chrome.tabs.onUpdated.addListener(onUpdate_handler);	
    chrome.pageAction.onClicked.addListener(onClick_handler);

	</script>
</html>

