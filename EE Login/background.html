<html>
  <script>
   var re = {
      'ee': /^http:\/\/[^.]+\.experts-exchange\.com\//,
      'eead': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/Admin_Only\//,
      'eemd': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/Mods_Only\//,
      'eeza': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/Admin_Mod_ZA_Only\//,
      'eepe': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/(?:PE_Adm|Admin_Mod_PE_Only)\//,
      'eepd': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/Private_Discussions\//,
      'eecv': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/CV_Admin\//,
      'eecg': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/General\//,
      'eecs': /^http:\/\/[^.]+\.experts-exchange\.com\/Community_Support\/Hidden\/(?!Admin_Only|Mods_Only|Admin_Mod_ZA_Only|Admin_Mod_PE_Only|Private_Discussions|CV_Admin)\//,
      'es': /^http:\/\/(?:[^.]+\.)?ee-stuff\.com\/?/,
      'esad': /^http:\/\/(?:[^.]+\.)?ee-stuff\.com\/Admin\//,
      'esmd': /^http:\/\/(?:[^.]+\.)?ee-stuff\.com\/Mod\//,
      'esza': /^http:\/\/(?:[^.]+\.)?ee-stuff\.com\/ZA\//,
      'espe': /^http:\/\/(?:[^.]+\.)?ee-stuff\.com\/PE\//,
      'escv': /^http:\/\/(?:[^.]+\.)?ee-stuff\.com\/CV\//,

   };

   var urlRe = /^https?:\/\/[^/]+/

   function get_redirect_url(tab)
   {
      var url;

      if(re['ee'].test(tab.url))
      {
         url = "https://secure.experts-exchange.com/login.jsp";
      }
      else
      if(re['es'].test(tab.url))
      {
         url = " http://ee-stuff.com/login.php";
      }

      if(url)
      {
         url += "?loginName=" + localStorage["username"];
         url += "&loginPassword=" + encodeURIComponent(localStorage["password"]);
         url += "&loginSubmit=1&redirect=" + tab.url.replace(urlRe, '');
      }

      return url;
   }

   function handle_login(tab, detach)
   {
      if(!localStorage["username"])
      {
         alert("You need to configure your EE username and password.");
         chrome.tabs.create({'url': "options.html"});
         return;
      }

      var url = get_redirect_url(tab);

      if(url)
      {
         chrome.windows.create({
            'url': url,
            'incognito': true
         });

         if(detach)
         {
            chrome.tabs.remove(tab.id);
         }
      }
   }

   function zone_handler(name, tab) {
      var ret = false

      if(localStorage[name] > 0 && re[name].test(tab.url))
      {
         handle_login(tab, (localStorage[name] == 2));
         ret = true;
      }

      return ret;
   }

   function onUpdate_handler(tabId, changeInfo, tab) {

      if(changeInfo.status == "loading") {
         if(tab.incognito)   {

            alert("EE Login doesn't work in incognito mode, please disable it!");

         } else {

            if(re['ee'].test(tab.url)) {

               chrome.pageAction.show(tabId);

               zone_handler('eemd', tab) ||
               zone_handler('eeza', tab) ||
               zone_handler('eepe', tab) ||
               zone_handler('eepd', tab) ||
               zone_handler('eecv', tab) ||
               zone_handler('eecg', tab) ||
               zone_handler('eecs', tab);
            }
            else
            if(re['es'].test(tab.url)) {

               chrome.pageAction.show(tabId);

               zone_handler('esad', tab) ||
               zone_handler('esmd', tab) ||
               zone_handler('esza', tab) ||
               zone_handler('espe', tab) ||
               zone_handler('escv', tab);
            }
         }
      }
   }

   function onClick_handler(tab) {

      handle_login(tab, localStorage["detonman"] == "true");
    }

    chrome.tabs.onUpdated.addListener(onUpdate_handler);
    chrome.pageAction.onClicked.addListener(onClick_handler);

   </script>
</html>

